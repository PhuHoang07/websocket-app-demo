<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WS Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        .msg {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .msg-content {
            white-space: pre-wrap;
        }

        .msg-status {
            font-size: 12px;
            color: gray;
            margin-left: 10px;
        }

        .system {
            color: gray;
            font-style: italic;
        }
    </style>
</head>

<body>
    <h3>WebSocket Chat Test</h3>

    <!-- USER -->
    <div>
        <input id="username" placeholder="Your name (for join/create)" />
    </div>

    <br />

    <!-- CREATE -->
    <button onclick="createConversation()">Create Conversation</button>

    <br /><br />

    <!-- JOIN / VIEW -->
    <input id="conversationId" placeholder="Conversation ID" />
    <button onclick="joinConversation()">Join</button>
    <button onclick="viewConversation()">View</button>

    <br /><br />

    <!-- CHAT -->
    <input id="messageInput" placeholder="Message" />
    <button onclick="sendMessage()">Send</button>

    <div id="messages"></div>

    <script>
        const ws = new WebSocket("ws://localhost:3000");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const pendingMessages = new Map();
        const messages = [];

        let currentConversationId = null;
        let username = null;
        let mode = null; // "JOIN" | "VIEW"

        function formatTime(dateString) {
            const date = new Date(dateString);

            return date.toLocaleString("vi-VN", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                day: "2-digit",
                month: "2-digit",
            });
        }

        function addSystemMessage(text) {
            const div = document.createElement("div");
            div.className = "system";
            div.textContent = text;
            messagesDiv.appendChild(div);
        }

        function addChatMessage(sender, content, createdAt) {
            const div = document.createElement("div");
            div.className = "msg";

            const time = createdAt ? formatTime(createdAt) : "";
            div.textContent = `[${time}] ${sender}: ${content}`;

            messagesDiv.appendChild(div);
        }

        function setSendEnabled(enabled) {
            messageInput.disabled = !enabled;
        }

        ws.onopen = () => {
            addSystemMessage("Connected to server");
            setSendEnabled(false);
        };

        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);

            switch (msg.type) {
                case "CONVERSATION_CREATED":
                    currentConversationId = msg.conversationId;
                    addSystemMessage(
                        `Conversation created: ${msg.conversationId}`,
                    );
                    break;

                case "JOIN_SUCCESS":
                    mode = "JOIN";
                    currentConversationId = msg.conversationId;
                    messagesDiv.innerHTML = "";
                    addSystemMessage("Joined conversation");
                    setSendEnabled(true);
                    autoScroll();
                    break;

                case "JOIN_REFUSED":
                    addSystemMessage("Join refused: " + msg.reason);
                    break;

                case "HISTORY":
                    messages.length = 0;

                    msg.data.forEach((m) => {
                        messages.push({
                            id: crypto.randomUUID(),
                            senderName: m.senderName,
                            content: m.content,
                            createdAt: m.createdAt,
                            status: "sent",
                        });
                    });

                    sortMessages();
                    renderMessages();

                    if (mode === "VIEW") {
                        addSystemMessage("Viewing conversation (read-only)");
                    }
                    break;

                case "NEW_MESSAGE":
                    messages.push({
                        id: crypto.randomUUID(),
                        senderName: msg.data.senderName,
                        content: msg.data.content,
                        createdAt: msg.data.createdAt,
                        status: "sent",
                    });

                    sortMessages();
                    renderMessages();
                    break;

                case "SYSTEM":
                    addSystemMessage(msg.message);
                    autoScroll();
                    break;

                case "MESSAGE_SENT": {
                    const idx = messages.findIndex(
                        (m) => m.id === msg.tempId
                    );

                    if (idx === -1) return;

                    messages[idx] = {
                        ...messages[idx],
                        createdAt: msg.data.createdAt,
                        status: "sent",
                    };

                    sortMessages();
                    renderMessages();
                    break;
                }
            }
        };

        function createConversation() {
            username = document.getElementById("username").value;
            if (!username) return alert("Enter username");

            resetState();

            ws.send(
                JSON.stringify({
                    type: "CREATE_CONVERSATION",
                    username,
                }),
            );
        }

        function joinConversation() {
            username = document.getElementById("username").value;
            const conversationId =
                document.getElementById("conversationId").value;

            if (!username || !conversationId)
                return alert("Enter username & conversationId");

            resetState();
            mode = "JOIN";

            ws.send(
                JSON.stringify({
                    type: "JOIN",
                    username,
                    conversationId,
                }),
            );
        }

        function viewConversation() {
            const conversationId =
                document.getElementById("conversationId").value;

            if (!conversationId)
                return alert("Enter conversationId");

            resetState();
            mode = "VIEW";
            currentConversationId = conversationId;

            ws.send(
                JSON.stringify({
                    type: "VIEW",
                    conversationId,
                }),
            );
        }

        function sendMessage() {
            if (mode !== "JOIN") return;

            const content = messageInput.value;
            if (!content) return;

            const tempId = crypto.randomUUID();

            messages.push({
                id: tempId,
                senderName: username,
                content,
                createdAt: null,
                status: "sending",
            });

            renderMessages();

            ws.send(
                JSON.stringify({
                    type: "MESSAGE",
                    tempId,
                    content,
                }),
            );

            messageInput.value = "";
        }

        function sortMessages() {
            messages.sort((a, b) => {
                if (!a.createdAt) return 1;
                if (!b.createdAt) return -1;

                return new Date(a.createdAt) - new Date(b.createdAt);
            });
        }

        function renderMessages() {
            messagesDiv.innerHTML = "";

            messages.forEach((m) => {
                const div = document.createElement("div");
                div.className = "msg";

                const text = document.createElement("span");
                let prefix = "";

                if (m.createdAt) {
                    prefix = `[${formatTime(m.createdAt)}] `;
                }

                text.textContent = `${prefix}${m.senderName}: ${m.content}`;

                div.appendChild(text);

                if (m.status === "sending") {
                    const status = document.createElement("span");
                    status.style.float = "right";
                    status.style.fontSize = "12px";
                    status.style.color = "gray";
                    status.textContent = "sending...";
                    div.appendChild(status);
                }

                messagesDiv.appendChild(div);
            });

            autoScroll();
        }

        function autoScroll() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function resetState() {
            mode = null;
            currentConversationId = null;
            messagesDiv.innerHTML = "";
            setSendEnabled(false);
        }

    </script>
</body>

</html>