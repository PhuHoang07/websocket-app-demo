<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>WS Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 10px;
        }

        .msg {
            margin-bottom: 6px;
        }

        .system {
            color: gray;
            font-style: italic;
        }
    </style>
</head>

<body>
    <h3>WebSocket Chat Test</h3>

    <!-- USER -->
    <div>
        <input id="username" placeholder="Your name (for join/create)" />
    </div>

    <br />

    <!-- CREATE -->
    <button onclick="createConversation()">Create Conversation</button>

    <br /><br />

    <!-- JOIN / VIEW -->
    <input id="conversationId" placeholder="Conversation ID" />
    <button onclick="joinConversation()">Join</button>
    <button onclick="viewConversation()">View</button>

    <br /><br />

    <!-- CHAT -->
    <input id="messageInput" placeholder="Message" />
    <button onclick="sendMessage()">Send</button>

    <div id="messages"></div>

    <script>
        const ws = new WebSocket("ws://localhost:3000");
        const messagesDiv = document.getElementById("messages");
        const messageInput = document.getElementById("messageInput");
        const pendingMessages = new Map();

        let currentConversationId = null;
        let username = null;
        let mode = null; // "JOIN" | "VIEW"

        function formatTime(dateString) {
            const date = new Date(dateString);

            return date.toLocaleString("vi-VN", {
                timeZone: "Asia/Ho_Chi_Minh",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                day: "2-digit",
                month: "2-digit",
                year: "2-digit",
            });
        }

        function addSystemMessage(text) {
            const div = document.createElement("div");
            div.className = "system";
            div.textContent = text;
            messagesDiv.appendChild(div);
        }

        function addChatMessage(sender, content, createdAt) {
            const div = document.createElement("div");
            div.className = "msg";

            const time = createdAt ? formatTime(createdAt) : "";
            div.textContent = `[${time}] ${sender}: ${content}`;

            messagesDiv.appendChild(div);
        }

        function setSendEnabled(enabled) {
            messageInput.disabled = !enabled;
        }

        ws.onopen = () => {
            addSystemMessage("Connected to server");
            setSendEnabled(false);
        };

        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);

            switch (msg.type) {
                case "CONVERSATION_CREATED":
                    currentConversationId = msg.conversationId;
                    addSystemMessage(
                        `Conversation created: ${msg.conversationId}`,
                    );
                    break;

                case "JOIN_SUCCESS":
                    mode = "JOIN";
                    currentConversationId = msg.conversationId;
                    messagesDiv.innerHTML = "";
                    addSystemMessage("Joined conversation");
                    setSendEnabled(true);
                    break;

                case "JOIN_REFUSED":
                    addSystemMessage("Join refused: " + msg.reason);
                    break;

                case "HISTORY":
                    messagesDiv.innerHTML = "";
                    msg.data.forEach((m) => {
                        addChatMessage(m.senderName, m.content, m.createdAt);
                    });
                    if (mode === "VIEW") {
                        addSystemMessage("Viewing conversation (read-only)");
                    }
                    break;

                case "NEW_MESSAGE":
                    addChatMessage(
                        msg.data.senderName,
                        msg.data.content,
                        msg.data.createdAt
                    );
                    break;

                case "SYSTEM":
                    addSystemMessage(msg.message);
                    break;

                case "MESSAGE_SENT": {
                    const div = pendingMessages.get(msg.tempId);
                    if (!div) return;

                    const time = formatTime(msg.data.createdAt);
                    div.textContent = `[sent ${time}] ${msg.data.senderName}: ${msg.data.content}`;

                    pendingMessages.delete(msg.tempId);
                    break;
                }
            }
        };

        function createConversation() {
            username = document.getElementById("username").value;
            if (!username) return alert("Enter username");

            resetState();

            ws.send(
                JSON.stringify({
                    type: "CREATE_CONVERSATION",
                    username,
                }),
            );
        }


        function joinConversation() {
            username = document.getElementById("username").value;
            const conversationId =
                document.getElementById("conversationId").value;

            if (!username || !conversationId)
                return alert("Enter username & conversationId");

            resetState();
            mode = "JOIN";

            ws.send(
                JSON.stringify({
                    type: "JOIN",
                    username,
                    conversationId,
                }),
            );
        }


        function viewConversation() {
            const conversationId =
                document.getElementById("conversationId").value;

            if (!conversationId)
                return alert("Enter conversationId");

            resetState();
            mode = "VIEW";
            currentConversationId = conversationId;

            ws.send(
                JSON.stringify({
                    type: "VIEW",
                    conversationId,
                }),
            );
        }

        function sendMessage() {
            if (mode !== "JOIN") return;

            const content = messageInput.value;
            if (!content) return;

            const tempId = crypto.randomUUID();

            const div = document.createElement("div");
            div.className = "msg";
            div.dataset.tempId = tempId;
            div.textContent = `[sending...] ${username}: ${content}`;
            messagesDiv.appendChild(div);

            pendingMessages.set(tempId, div);
            ws.send(
                JSON.stringify({
                    type: "MESSAGE",
                    tempId,
                    content,
                }),
            );

            messageInput.value = "";
        }


        function resetState() {
            mode = null;
            currentConversationId = null;
            messagesDiv.innerHTML = "";
            setSendEnabled(false);
        }

    </script>
</body>

</html>